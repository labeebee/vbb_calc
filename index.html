<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>Volleyball Budget ‚Äî v12 (Big Board + Fix)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { --blue:#0a84ff; --green:#34c759; --yellow:#ffd60a; --bg:#0b0f14; --card:#11151d; --border:#1f2937; --muted:#99a3ad; --text:#f2f2f7; }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  .wrap{max-width:980px;margin:0 auto;padding:16px;padding-bottom:calc(56px + env(safe-area-inset-bottom));}
  .card{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:12px}
  h1{font-size:20px;margin:0 0 10px;font-weight:700;letter-spacing:.2px}
  h2{font-size:16px;margin:0 0 10px;color:#cbd5e1;font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:800;font-size:16px;border:1px solid #2a3748;background:#0f172a}
  .pill.save{background:#062f3f;color:#7dd3fc;border-color:#164e63}
  .pill.std{background:#0b2f1f;color:#a7f3d0;border-color:#14532d}
  .pill.spend{background:#3a2a0c;color:#fde68a;border-color:#92400e}
  .meter{height:14px;background:#0f172a;border-radius:999px;overflow:hidden;border:1px solid #1f2937}
  .fill{height:100%;width:0%;transition:width .12s}
  .btn{flex:1 1 auto;padding:14px;border-radius:14px;border:1px solid #223044;background:#152032;color:var(--text);font-weight:800;cursor:pointer;touch-action:manipulation}
  .btn:active{transform:scale(.99)}
  .btn.good{border-color:#064e3b;background:#0b2a22}
  .btn.bad{border-color:#5b0b0b;background:#2b0b0b}
  .btn.small{padding:10px;font-size:13px}
  .chip{display:inline-block;border:1px solid #334155;padding:8px 12px;border-radius:999px;font-size:14px;color:#d1d5db;margin:2px 6px 0 0;cursor:pointer;user-select:none}
  .chip strong{color:#fff}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,"Roboto Mono",monospace;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  td,th{padding:10px;vertical-align:middle}
  th{font-size:12px;color:#cbd5e1;text-align:left;font-weight:700;letter-spacing:.3px}
  tr{background:#0f172a;border-radius:14px}
  tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
  input[type="text"],input[type="number"],input[type="range"]{padding:8px 10px;border-radius:10px;border:1px solid #233042;background:#101826;color:#fff;width:100%}
  input[type="range"]{padding:0;height:32px}
  .tag{padding:6px 10px;border-radius:999px;border:1px solid #334155;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap}
  .tag.play{background:#0b2f1f;color:#a7f3d0;border-color:#14532d}
  .tag.sub{background:#3a2a0c;color:#fde68a;border-color:#92400e}
  .flash{outline:2px solid #64748b;outline-offset:2px;transition:outline .15s}
  .footer{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(11,15,20,0),rgba(11,15,20,.9));padding:8px 14px env(safe-area-inset-bottom);backdrop-filter:blur(8px)}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:44px;height:28px;appearance:none;background:#334155;border-radius:999px;position:relative;outline:none;cursor:pointer}
  .switch input:checked{background:#14532d}
  .switch input::after{content:"";width:22px;height:22px;background:white;border-radius:50%;position:absolute;top:3px;left:3px;transition:left .12s}
  .switch input:checked::after{left:19px}
  .seg{display:inline-flex;border:1px solid #334155;border-radius:12px;overflow:hidden}
  .seg button{padding:8px 12px;border:0;background:#0f172a;color:#cbd5e1;font-weight:700}
  .seg button.active{background:#1b283a;color:#fff}
  details{border:1px solid #233042;background:#0f172a;border-radius:14px;padding:10px;margin:8px 0}
  summary{cursor:pointer;font-weight:800;color:#e2e8f0;outline:none}
  details p{margin:8px 0;color:#cbd5e1}
  .ex-note{font-size:12px;color:#94a3b8}
  /* Mobile layout fix for table labels */
  @media (max-width:560px){
    .row .btn{flex:1 1 48%}
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tr{margin-bottom:10px;padding:8px}
    td{display:grid;grid-template-columns: 44% 56%;gap:6px;align-items:start;padding:6px 8px;word-break:break-word}
    td::before{content:attr(data-label);font-weight:700;color:#94a3b8;white-space:normal}
    input[type="text"]{min-width:0}
    .tag{white-space:normal}
  }
  .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#0e1622;border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid #243042;box-shadow:0 -10px 30px rgba(0,0,0,.4);transition:bottom .18s;padding:12px 14px;max-height:70vh;overflow:auto}
  .sheet.open{bottom:0}
  .player-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #334155;border-radius:999px;padding:8px 12px;margin:4px 6px;cursor:pointer}
  .player-chip.active{background:#2a3a55}
  .fatigue{font-size:11px;color:#a3b1c2}

  /* Big Budget Board */
  .bigboard{position:fixed;inset:0;background:#000c;backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:9999}
  .bigboard.show{display:flex}
  .bigwrap{background:#0b1120;border:1px solid #1f2a44;border-radius:24px;box-shadow:0 10px 40px rgba(0,0,0,.6);padding:20px 26px;text-align:center;max-width:92vw}
  .bignum{font-size:20vh;line-height:1;font-weight:900;letter-spacing:2px}
  .bigcall{margin-top:8px;font-size:3vh;font-weight:800;opacity:.9}
  .bighint{margin-top:6px;font-size:2vh;color:#a8b1c7}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üèê Volleyball Budget ‚Äî v12</h1>
    <div class="row">
      <div class="pill" id="scorePill">Set <span id="setNum">1</span> ‚Ä¢ Score: <span id="us">0</span> ‚Äì <span id="them">0</span></div>
      <div class="pill" id="callPill">Call: ‚Äî</div>
      <div class="pill" id="budgetPill" style="font-size:22px">B: <span id="bVal">0.50</span></div>
      <button class="btn small" id="openBig">üì£ Big Budget</button>
    </div>
    <div class="meter" style="margin-top:8px"><div class="fill" id="bar"></div></div>

    <div class="row" style="margin-top:8px">
      <label class="switch"><input type="checkbox" id="usePlayers" checked /><span class="muted">Include players in budget</span></label>
      <div class="seg" id="modeSeg">
        <button data-mode="blend" class="active">Blend</button>
        <button data-mode="bottleneck">Bottleneck</button>
      </div>
    </div>
    <div class="row">
      <div class="col" style="flex:1 1 180px">
        <label class="mono">Team weight (w): <span id="wTeamLabel">0.70</span> ‚Ä¢ Players weight (1‚àíw): <span id="wPlayersLabel">0.30</span></label>
        <input type="range" id="wTeam" min="0" max="1" step="0.01" value="0.70" />
      </div>
    </div>

    <div class="muted mono" style="margin-top:6px">B_team = clip(0.3¬∑m + 0.3¬∑w + 0.3¬∑c + 0.1¬∑r + k, 0..1)</div>
    <div class="muted mono">B_players = avg(<b>PA</b>) of <b>Playing</b></div>
    <div class="muted mono">B_final = <span id="formulaText">clip(w¬∑B_team + (1‚àíw)¬∑B_players, 0..1)</span></div>
    <div class="muted mono" style="margin-top:6px">B_team: <span id="bTeamShow">0.50</span> ‚Ä¢ B_players: <span id="bPlayersShow">0.65</span> ‚Ä¢ B_raw: <span id="bRawShow">0.50</span></div>
  </div>

  <div class="card">
    <h2>One‚ÄëTap Rally</h2>
    <div class="row">
      <button class="btn good" id="win3">‚úÖ Win 3‚Äëball</button>
      <button class="btn good" id="win2">‚úÖ Win 2‚Äëball</button>
      <button class="btn bad"  id="loss3">‚ùå Loss 3‚Äëball</button>
      <button class="btn bad"  id="loss2">‚ùå Loss 2‚Äëball</button>
      <button class="btn small" id="errTeam">‚ö†Ô∏è Team error</button>
      <button class="btn small" id="errPlayers">üßØ Errors (players)</button>
      <button class="btn small" id="undo">‚Ü©Ô∏è Undo</button>
      <button class="btn small" id="reset">‚ôªÔ∏è Reset (match)</button>
      <button class="btn small" id="nextSet">‚û°Ô∏è Next Set</button>
      <button class="btn small" id="exportCsv">‚¨áÔ∏è Export CSV</button>
    </div>
  </div>

  <div class="card">
    <h2>Fatigue & Carry‚Äëforward</h2>
    <div class="muted">On <b>Next Set</b>: players who appeared carry their <b>PA</b> forward; bench decays toward 0.5. If a player plays in <b>&gt;2 consecutive sets</b>, fatigue reduces PA per extra set.</div>
    <div class="row" style="margin-top:8px">
      <div class="col" style="flex:1 1 180px">
        <label class="mono">Fatigue per extra set (default 0.03): <span id="fatigueStepLabel">0.03</span></label>
        <input type="range" id="fatigueStep" min="0" max="0.10" step="0.01" value="0.03" />
      </div>
      <div class="col" style="flex:1 1 180px">
        <label class="mono">Decay for bench toward 0.5 (default 0.50): <span id="benchDecayLabel">0.50</span></label>
        <input type="range" id="benchDecay" min="0" max="1" step="0.05" value="0.50" />
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Players (affect budget)</h2>
    <table id="playersTable">
      <thead>
        <tr><th>#</th><th>Name</th><th>Status</th><th>PA (0‚Äì1)</th><th>Touch</th><th>Consec Sets</th><th>Fatigue</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="subHint">üîÅ Sub Hint</button>
      <span class="muted mono" id="onCourtAvg"></span>
    </div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h2>‚ÑπÔ∏è Explainers (tap to expand)</h2>
    <details><summary>Margin <span class="mono">(m)</span></summary>
      <p>Score gap this moment. +1 if you‚Äôre ahead by ‚â•2, ‚àí1 if behind by ‚â§‚àí2, else 0. Higher margin ‚Üí more budget to spend.</p>
      <p class="ex-note">Why: Big leads let you take calculated risks; big deficits suggest stabilizing until you claw back.</p>
    </details>
    <details><summary>Momentum <span class="mono">(w)</span></summary>
      <p>Short‚Äëterm streak over last 3 rallies: wins minus losses, scaled to [‚àí1,1]. Sustained wins lift budget; losses pull it down.</p>
      <p class="ex-note">Why: Captures immediate rhythm without overreacting to a single point.</p>
    </details>
    <details><summary>Cleanliness <span class="mono">(c)</span></summary>
      <p>Error tally over last few rallies: 1.00 (no errors), 0.60 (one), 0.30 (two+). Cleaner play permits bolder calls.</p>
      <p class="ex-note">Why: If execution is messy, risk is more likely to backfire.</p>
    </details>
    <details><summary>Rhythm <span class="mono">(r)</span></summary>
      <p>Coach/observer ‚Äúvibe‚Äù slider (0.3/0.5/0.7). Represents composure, communication, serve‚Äëreceive comfort.</p>
      <p class="ex-note">Why: Some nights the intangibles are real ‚Äî bake them in, lightly.</p>
    </details>
    <details><summary>Confidence kick <span class="mono">(k)</span></summary>
      <p>Quick bonus from risky plays: +0.10 for winning a 2‚Äëball (‚àí0.10 if lost), +0.05/‚àí0.05 for 3‚Äëball results.</p>
      <p class="ex-note">Why: Success/failure on bold attempts should nudge the dial.</p>
    </details>
    <details><summary>Team budget <span class="mono">(B_team)</span></summary>
      <p><span class="mono">clip(0.3¬∑m + 0.3¬∑w + 0.3¬∑c + 0.1¬∑r + k, 0..1)</span>. Aggregates team‚Äëstate; the core ‚Äúhow ready are we?‚Äù score.</p>
    </details>
    <details><summary>Players budget <span class="mono">(B_players)</span></summary>
      <p>Average <b>PA</b> of on‚Äëcourt players. Reflects individual allowance to take risk right now.</p>
    </details>
    <details><summary>Blend vs Bottleneck</summary>
      <p><b>Blend:</b> <span class="mono">clip(w¬∑B_team + (1‚àíw)¬∑B_players, 0..1)</span>. Smooth mix ‚Äî good default for balanced teams.</p>
      <p><b>Bottleneck:</b> <span class="mono">min(B_team, B_players)</span>. Conservative ‚Äî the weaker of system vs individuals caps risk.</p>
    </details>
    <details><summary>Clipping <span class="mono">clip(x,0,1)</span></summary>
      <p>Keeps budget in a usable 0..1 range: <span class="mono">max(0, min(x,1))</span>. Prevents runaway highs/lows and stabilizes calls.</p>
    </details>
    <details><summary>Fatigue & Bench decay</summary>
      <p>On <b>Next Set</b>: appearances carry forward; bench decays toward 0.5 by a factor you control. Consecutive sets &gt;2 apply a fatigue penalty per extra set to <b>PA</b>.</p>
    </details>
  </div>
</div>

<!-- Big Budget Overlay -->
<div class="bigboard" id="bigBoard">
  <div class="bigwrap" id="bigWrap">
    <div class="bignum" id="bigNum">0.50</div>
    <div class="bigcall" id="bigCall">STANDARD</div>
    <div class="bighint">Tap anywhere to close</div>
  </div>
</div>

<!-- Error Sharing Sheet -->
<div class="sheet" id="errSheet">
  <h2>Mark player errors (this rally)</h2>
  <div id="errPlayersList" class="row"></div>
  <div class="row" style="margin-top:10px">
    <button class="btn small" id="applyErr">Apply penalties</button>
    <button class="btn small" id="closeErr">Close</button>
  </div>
  <div class="muted" style="margin-top:6px">Penalty is shared: each selected player gets ‚àí0.03 to <b>PA</b> (clipped), and team cleanliness for this rally counts as an error.</div>
</div>

<div class="footer"><div class="muted">Tip: Save to Files ‚Üí open in Safari ‚Üí Share ‚Üí ‚ÄúAdd to Home Screen‚Äù for app‚Äëlike feel.</div></div>

<script>
let setNumber=1;
let us=0, them=0;
let lastResults=[], lastErrors=[];
let vibe=0.5, k=0;
let mManual=null, wManual=null, cManual=null, rManual=null, kManual=null;
let history=[];
let eventLog=[];
let mode='blend';
let wTeam=0.70;
let fatigueStep=0.03; // per extra set beyond 2
let benchDecay=0.50;  // toward 0.5
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));
let bigOpen=false;

const playersDefault=[
  {name:'Labeeb',  status:'Playing', pa:0.70, consec:0, playedThisSet:false},
  {name:'Jassim',  status:'Playing', pa:0.60, consec:0, playedThisSet:false},
  {name:'Areej',   status:'Playing', pa:0.70, consec:0, playedThisSet:false},
  {name:'Jawad',   status:'Playing', pa:0.60, consec:0, playedThisSet:false},
  {name:'Samad',   status:'Playing', pa:0.70, consec:0, playedThisSet:false},
  {name:'Shanoob', status:'Playing', pa:0.60, consec:0, playedThisSet:false},
  {name:'Shamal',  status:'Sub',     pa:0.75, consec:0, playedThisSet:false},
];
let players=JSON.parse(JSON.stringify(playersDefault));

function marginVal(){ if(mManual!==null) return mManual; const d=us-them; if(d>=2) return 1; if(d<=-2) return -1; return 0; }
function momentumVal(){ if(wManual!==null) return wManual; const w=lastResults.filter(x=>'win'===x).length; const l=lastResults.filter(x=>'loss'===x).length; return (w-l)/3; }
function cleanlinessVal(){ if(cManual!==null) return cManual; const s=lastErrors.reduce((a,b)=>a+b,0); if(s===0) return 1.0; if(s===1) return 0.6; return 0.3; }
function rVal(){ return (rManual!==null)?rManual:vibe; }
function kVal(){ return (kManual!==null)?kManual:k; }
function bTeamRaw(){ return 0.3*marginVal()+0.3*momentumVal()+0.3*cleanlinessVal()+0.1*rVal()+kVal(); }
function bTeam(){ return clamp(bTeamRaw(),0,1); }
function bPlayers(){
  const on=players.filter(p=>p.status==='Playing');
  if(on.length===0) return 0.5;
  const avg=on.reduce((s,p)=>s+(p.pa||0.6),0)/on.length;
  return clamp(avg,0,1);
}
function bRawCombined(team, playersAvg){
  if(!document.getElementById('usePlayers').checked) return team;
  if(mode==='bottleneck') return Math.min(team, playersAvg);
  return wTeam*team + (1-wTeam)*playersAvg;
}
function bFinal(){
  const team=bTeam(); const playersAvg=bPlayers();
  const raw=bRawCombined(team, playersAvg);
  return clamp(raw,0,1);
}
function flash(el){ el.classList.add('flash'); setTimeout(()=>el.classList.remove('flash'),140); }
function updateBigBoard(finalB, callText){
  const big=document.getElementById('bigBoard');
  const num=document.getElementById('bigNum');
  const call=document.getElementById('bigCall');
  const wrap=document.getElementById('bigWrap');
  num.textContent=finalB.toFixed(2);
  call.textContent=callText;
  if(finalB<0.35){ wrap.style.borderColor='#1e3a8a'; num.style.color='#60a5fa'; call.style.color='#93c5fd'; }
  else if(finalB<0.65){ wrap.style.borderColor='#14532d'; num.style.color='#34d399'; call.style.color='#86efac'; }
  else{ wrap.style.borderColor='#92400e'; num.style.color='#fde68a'; call.style.color='#fcd34d'; }
}
function updateUI(){
  const team=bTeam(), playersAvg=bPlayers();
  const raw=bRawCombined(team, playersAvg);
  const finalB=clamp(raw,0,1);
  const m=marginVal(), w=momentumVal(), c=cleanlinessVal(), r=rVal(), kk=kVal();

  document.getElementById('setNum').textContent=setNumber;
  document.getElementById('bVal').textContent=finalB.toFixed(2);
  document.getElementById('bTeamShow').textContent=team.toFixed(2);
  document.getElementById('bPlayersShow').textContent=playersAvg.toFixed(2);
  document.getElementById('bRawShow').textContent=raw.toFixed(2);

  const bar=document.getElementById('bar'); bar.style.width=(finalB*100)+'%';
  const callPill=document.getElementById('callPill'); const budgetPill=document.getElementById('budgetPill');
  let callText='STANDARD';
  if(finalB<0.35){ callPill.className='pill save'; callPill.textContent='Call: SAVE'; bar.style.background='#0a84ff'; budgetPill.className='pill save'; callText='SAVE'; }
  else if(finalB<0.65){ callPill.className='pill std'; callPill.textContent='Call: STANDARD'; bar.style.background='#34c759'; budgetPill.className='pill std'; callText='STANDARD'; }
  else{ callPill.className='pill spend'; callPill.textContent='Call: SPEND'; bar.style.background='#ffd60a'; budgetPill.className='pill spend'; callText='SPEND'; }
  flash(budgetPill);

  document.getElementById('wTeamLabel').textContent=wTeam.toFixed(2);
  document.getElementById('wPlayersLabel').textContent=(1-wTeam).toFixed(2);
  document.getElementById('formulaText').textContent = (mode==='bottleneck')
    ? 'min(B_team, B_players)'
    : 'clip(w¬∑B_team + (1‚àíw)¬∑B_players, 0..1)';
  const on=players.filter(p=>p.status==='Playing');
  const avg=on.length? (on.reduce((s,p)=>s+(p.pa||0.6),0)/on.length) : 0;
  document.getElementById('onCourtAvg').textContent = `On‚Äëcourt avg PA: ${avg.toFixed(2)} (${on.length} players)`;
  document.getElementById('us').textContent=us;
  document.getElementById('them').textContent=them;

  if (bigOpen){ updateBigBoard(finalB, callText); }
}
function pushHistory(extra={}){
  history.push({
    setNumber, us, them, lastResults:[...lastResults], lastErrors:[...lastErrors], vibe, k,
    mManual, wManual, cManual, rManual, kManual,
    players:JSON.parse(JSON.stringify(players)),
    usePlayers:document.getElementById('usePlayers').checked, mode, wTeam, fatigueStep, benchDecay,
    ...extra
  });
}
function snapshotPAs(){
  const snap={};
  players.forEach(p=>{ snap['PA_'+p.name]= (p.pa!==undefined? p.pa.toFixed(2):''); });
  return snap;
}
function logEvent(type, extra={}){
  const team=bTeam(), playersAvg=bPlayers();
  const raw=bRawCombined(team, playersAvg);
  const finalB=clamp(raw,0,1);
  const timestamp=new Date().toISOString();
  const entry={timestamp,set:setNumber,type,us,them,
    m:marginVal(), w:momentumVal(), c:cleanlinessVal(), r:rVal(), k:kVal(),
    B_team:team, B_players:playersAvg, B_raw:raw, B_final:finalB,
    mode, wTeam, fatigueStep, benchDecay,
    ...snapshotPAs(),
    ...extra
  };
  eventLog.push(entry);
}
function rally(res,balls){
  players.forEach(p=>{ if(p.status==='Playing') p.playedThisSet=true; });
  if(res==='win') us++; else them++;
  lastResults.push(res); if(lastResults.length>3) lastResults.shift();
  k = (balls==='2') ? ((res==='win')?+0.10:-0.10) : ((res==='win')?+0.05:-0.05);
  lastErrors.push(0); if(lastErrors.length>3) lastErrors.shift();
  pushHistory({event:`rally:${res}:${balls}`});
  logEvent('rally',{result:res,balls});
  updateUI();
}
function markTeamErr(){
  if(lastErrors.length>0){
    lastErrors[lastErrors.length-1]=1;
    pushHistory({event:'team_error'});
    logEvent('team_error',{});
    updateUI();
  }
}
function openErrSheet(){
  const sheet=document.getElementById('errSheet');
  const list=document.getElementById('errPlayersList');
  list.innerHTML='';
  players.filter(p=>p.status==='Playing').forEach((p)=>{
    const chip=document.createElement('div');
    chip.className='player-chip';
    chip.dataset.name=p.name;
    chip.textContent=p.name;
    chip.addEventListener('click',()=>{ chip.classList.toggle('active'); });
    list.appendChild(chip);
  });
  sheet.classList.add('open');
}
function closeErrSheet(){ document.getElementById('errSheet').classList.remove('open'); }
function applyErrPenalties(){
  const selected=[...document.querySelectorAll('.player-chip.active')].map(el=>el.dataset.name);
  if(selected.length>0){
    players.forEach(p=>{ if(selected.includes(p.name)){ p.pa = clamp((p.pa||0.6)-0.03,0,1); p.playedThisSet=true; } });
    renderPlayers();
    if(lastErrors.length>0){ lastErrors[lastErrors.length-1]=1; }
    pushHistory({event:'player_errors',selected:[...selected]});
    logEvent('player_errors',{players:selected.join('|')});
  }
  updateUI(); closeErrSheet();
}
function undo(){
  if(history.length>0){
    const h=history.pop();
    setNumber=h.setNumber;
    us=h.us; them=h.them; lastResults=[...h.lastResults]; lastErrors=[...h.lastErrors]; vibe=h.vibe; k=h.k;
    mManual=h.mManual; wManual=h.wManual; cManual=h.cManual; rManual=h.rManual; kManual=h.kManual;
    players=JSON.parse(JSON.stringify(h.players));
    document.getElementById('usePlayers').checked = h.usePlayers;
    mode=h.mode; wTeam=h.wTeam; fatigueStep=h.fatigueStep; benchDecay=h.benchDecay;
    document.getElementById('wTeam').value=wTeam;
    document.getElementById('fatigueStep').value=fatigueStep.toFixed(2);
    document.getElementById('benchDecay').value=benchDecay.toFixed(2);
    updateControlsText();
    document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
    renderPlayers(); updateUI();
  }
}
function resetAll(){
  setNumber=1;
  us=0; them=0; lastResults=[]; lastErrors=[]; vibe=0.5; k=0;
  mManual=wManual=cManual=rManual=kManual=null; history=[]; eventLog=[];
  players=JSON.parse(JSON.stringify(playersDefault));
  mode='blend'; wTeam=0.70; fatigueStep=0.03; benchDecay=0.50;
  document.getElementById('usePlayers').checked = true;
  document.getElementById('wTeam').value=wTeam;
  document.getElementById('fatigueStep').value=fatigueStep.toFixed(2);
  document.getElementById('benchDecay').value=benchDecay.toFixed(2);
  updateControlsText();
  document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
  renderPlayers(); updateUI();
}
function updateControlsText(){
  document.getElementById('fatigueStepLabel').textContent=parseFloat(fatigueStep).toFixed(2);
  document.getElementById('benchDecayLabel').textContent=parseFloat(benchDecay).toFixed(2);
}
function nextSet(){
  players.forEach(p=>{
    if(p.playedThisSet){
      p.consec += 1;
      const extra = Math.max(0, p.consec - 2);
      const penalty = extra * fatigueStep;
      if (extra > 0 && penalty > 0){
        p.pa = clamp(p.pa - penalty, 0, 1);
      }
    } else {
      p.consec = 0;
      p.pa = clamp(0.5 + (p.pa - 0.5) * (1 - benchDecay), 0, 1);
    }
    p.playedThisSet = false;
  });
  setNumber += 1;
  us=0; them=0; lastResults=[]; lastErrors=[]; vibe=0.5; k=0;
  pushHistory({event:'next_set'});
  logEvent('next_set',{});
  renderPlayers(); updateUI();
}
function renderPlayers(){
  const tbody=document.querySelector('#playersTable tbody');
  tbody.innerHTML='';
  players.forEach((p,i)=>{
    const extra=Math.max(0, p.consec - 2);
    const fatigue=(extra>0)? (extra*fatigueStep): 0;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td data-label="#">${i+1}</td>
      <td data-label="Name"><input type="text" value="${p.name}" data-idx="${i}" class="pname" /></td>
      <td data-label="Status"><button class="tag ${p.status==='Playing'?'play':'sub'}" data-idx="${i}" data-role="toggle">${p.status}</button></td>
      <td data-label="PA (0‚Äì1)"><input type="number" step="0.01" min="0" max="1" value="${p.pa.toFixed(2)}" data-idx="${i}" class="ppa" /></td>
      <td data-label="Touch">
        <button class="tag play" data-idx="${i}" data-delta="0.05">üëç Good</button>
        <button class="tag sub" data-idx="${i}" data-delta="-0.05">‚ö†Ô∏è Error</button>
      </td>
      <td data-label="Consec Sets"><span class="fatigue">${p.consec}</span></td>
      <td data-label="Fatigue"><span class="fatigue">‚àí${fatigue.toFixed(2)}</span></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.pname').forEach(el=>el.addEventListener('input',e=>{ players[e.target.dataset.idx].name=e.target.value; updateUI(); }));
  tbody.querySelectorAll('[data-role="toggle"]').forEach(el=>el.addEventListener('click',e=>{
    const i=e.target.dataset.idx; players[i].status = (players[i].status==='Playing')?'Sub':'Playing';
    if(players[i].status==='Playing'){ players[i].playedThisSet=true; }
    renderPlayers(); updateUI();
    pushHistory({event:'toggle_status',i,status:players[i].status}); logEvent('toggle_status',{name:players[i].name,status:players[i].status});
  }));
  tbody.querySelectorAll('.ppa').forEach(el=>el.addEventListener('input',e=>{
    const i=e.target.dataset.idx; const v=parseFloat(e.target.value); players[i].pa = isNaN(v)?players[i].pa:clamp(v,0,1); updateUI();
    pushHistory({event:'set_pa',i,value:players[i].pa}); logEvent('set_pa',{name:players[i].name,pa:players[i].pa});
  }));
  tbody.querySelectorAll('[data-delta]').forEach(el=>el.addEventListener('click',e=>{
    const i=e.target.dataset.idx; const d=parseFloat(e.target.dataset.delta); players[i].pa = clamp((players[i].pa||0)+d,0,1);
    if(d>0 && players[i].status==='Playing'){ players[i].playedThisSet=true; }
    renderPlayers(); updateUI();
    pushHistory({event:'nudge_pa',i,delta:d}); logEvent('nudge_pa',{name:players[i].name,delta:d,pa:players[i].pa});
  }));
}
function exportCSV(){
  const baseHeaders=['timestamp','set','type','us','them','m','w','c','r','k','B_team','B_players','B_raw','B_final','mode','wTeam','fatigueStep','benchDecay'];
  const paHeaders = players.map(p => 'PA_'+p.name);
  const headers=[...baseHeaders, ...paHeaders];
  const rows=[headers.join(',')];
  eventLog.forEach(e=>{
    const line=headers.map(h=> (e[h]!==undefined? e[h] : '')).join(',');
    rows.push(line);
  });
  const csv=rows.join('\\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='volleyball_budget_log.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('win3').addEventListener('click',()=>rally('win','3'));
  document.getElementById('win2').addEventListener('click',()=>rally('win','2'));
  document.getElementById('loss3').addEventListener('click',()=>rally('loss','3'));
  document.getElementById('loss2').addEventListener('click',()=>rally('loss','2'));
  document.getElementById('errTeam').addEventListener('click',markTeamErr);
  document.getElementById('errPlayers').addEventListener('click',openErrSheet);
  document.getElementById('applyErr').addEventListener('click',applyErrPenalties);
  document.getElementById('closeErr').addEventListener('click',()=>{closeErrSheet();});
  document.getElementById('undo').addEventListener('click',undo);
  document.getElementById('reset').addEventListener('click',resetAll);
  document.getElementById('nextSet').addEventListener('click',nextSet);
  document.getElementById('exportCsv').addEventListener('click',exportCSV);
  document.getElementById('usePlayers').addEventListener('change',updateUI);
  document.getElementById('wTeam').addEventListener('input',e=>{ wTeam=parseFloat(e.target.value)||0; updateUI(); });
  document.querySelectorAll('#modeSeg button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); mode=btn.dataset.mode;
      updateUI();
    });
  });
  // Big Board controls
  document.getElementById('openBig').addEventListener('click',()=>{
    bigOpen=true;
    document.getElementById('bigBoard').classList.add('show');
    updateUI();
  });
  document.getElementById('bigBoard').addEventListener('click',()=>{
    bigOpen=false;
    document.getElementById('bigBoard').classList.remove('show');
  });

  renderPlayers(); updateUI();
});
</script>
</body>
</html>
