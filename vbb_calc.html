<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>Volleyball Budget ‚Äî v8 (Weights + Bottleneck + Export)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { --blue:#0a84ff; --green:#34c759; --yellow:#ffd60a; --bg:#0b0f14; --card:#11151d; --border:#1f2937; --muted:#99a3ad; --text:#f2f2f7; }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  .wrap{max-width:980px;margin:0 auto;padding:16px;padding-bottom:calc(44px + env(safe-area-inset-bottom));}
  .card{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:12px}
  h1{font-size:20px;margin:0 0 10px;font-weight:700;letter-spacing:.2px}
  h2{font-size:16px;margin:0 0 10px;color:#cbd5e1;font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:800;font-size:16px;border:1px solid #2a3748;background:#0f172a}
  .pill.save{background:#062f3f;color:#7dd3fc;border-color:#164e63}
  .pill.std{background:#0b2f1f;color:#a7f3d0;border-color:#14532d}
  .pill.spend{background:#3a2a0c;color:#fde68a;border-color:#92400e}
  .meter{height:14px;background:#0f172a;border-radius:999px;overflow:hidden;border:1px solid #1f2937}
  .fill{height:100%;width:0%;transition:width .12s}
  .btn{flex:1 1 auto;padding:14px;border-radius:14px;border:1px solid #223044;background:#152032;color:var(--text);font-weight:800;cursor:pointer;touch-action:manipulation}
  .btn:active{transform:scale(.99)}
  .btn.good{border-color:#064e3b;background:#0b2a22}
  .btn.bad{border-color:#5b0b0b;background:#2b0b0b}
  .btn.small{padding:10px;font-size:13px}
  .chip{display:inline-block;border:1px solid #334155;padding:8px 12px;border-radius:999px;font-size:14px;color:#d1d5db;margin:2px 6px 0 0;cursor:pointer;user-select:none}
  .chip strong{color:#fff}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,"Roboto Mono",monospace;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  td,th{padding:10px}
  th{font-size:12px;color:#cbd5e1;text-align:left;font-weight:700;letter-spacing:.3px}
  tr{background:#0f172a;border-radius:14px}
  tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
  input[type="text"],input[type="number"],input[type="range"]{padding:8px 10px;border-radius:10px;border:1px solid #233042;background:#101826;color:#fff;width:100%}
  input[type="range"]{padding:0;height:32px}
  .tag{padding:6px 10px;border-radius:999px;border:1px solid #334155;font-size:12px;font-weight:700;cursor:pointer}
  .tag.play{background:#0b2f1f;color:#a7f3d0;border-color:#14532d}
  .tag.sub{background:#3a2a0c;color:#fde68a;border-color:#92400e}
  .flash{outline:2px solid #64748b;outline-offset:2px;transition:outline .15s}
  .footer{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(11,15,20,0),rgba(11,15,20,.9));padding:8px 14px env(safe-area-inset-bottom);backdrop-filter:blur(8px)}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:44px;height:28px;appearance:none;background:#334155;border-radius:999px;position:relative;outline:none;cursor:pointer}
  .switch input:checked{background:#14532d}
  .switch input::after{content:"";width:22px;height:22px;background:white;border-radius:50%;position:absolute;top:3px;left:3px;transition:left .12s}
  .switch input:checked::after{left:19px}
  .seg{display:inline-flex;border:1px solid #334155;border-radius:12px;overflow:hidden}
  .seg button{padding:8px 12px;border:0;background:#0f172a;color:#cbd5e1;font-weight:700}
  .seg button.active{background:#1b283a;color:#fff}
  @media (max-width:560px){
    .row .btn{flex:1 1 48%}
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tr{margin-bottom:8px;padding:8px}
    td{display:flex;justify-content:space-between;align-items:center;padding:6px 8px}
    td::before{content:attr(data-label);font-weight:700;color:#94a3b8}
  }
  .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#0e1622;border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid #243042;box-shadow:0 -10px 30px rgba(0,0,0,.4);transition:bottom .18s;padding:12px 14px;max-height:70vh;overflow:auto}
  .sheet.open{bottom:0}
  .player-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #334155;border-radius:999px;padding:8px 12px;margin:4px 6px;cursor:pointer}
  .player-chip.active{background:#2a3a55}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üèê Volleyball Budget ‚Äî v8</h1>
    <div class="row">
      <div class="pill" id="scorePill">Score: <span id="us">0</span> ‚Äì <span id="them">0</span></div>
      <div class="pill" id="callPill">Call: ‚Äî</div>
      <div class="pill" id="budgetPill" style="font-size:22px">B: <span id="bVal">0.50</span></div>
    </div>
    <div class="meter" style="margin-top:8px"><div class="fill" id="bar"></div></div>

    <div class="row" style="margin-top:8px">
      <label class="switch"><input type="checkbox" id="usePlayers" checked /><span class="muted">Include players in budget</span></label>
      <div class="seg" id="modeSeg">
        <button data-mode="blend" class="active">Blend</button>
        <button data-mode="bottleneck">Bottleneck</button>
      </div>
    </div>
    <div class="row">
      <div class="col" style="flex:1 1 180px">
        <label class="mono">Team weight (w): <span id="wTeamLabel">0.70</span> ‚Ä¢ Players weight (1‚àíw): <span id="wPlayersLabel">0.30</span></label>
        <input type="range" id="wTeam" min="0" max="1" step="0.01" value="0.70" />
      </div>
    </div>

    <div class="muted mono" style="margin-top:6px">B_team = clip(0.3¬∑m + 0.3¬∑w + 0.3¬∑c + 0.1¬∑r + k, 0..1)</div>
    <div class="muted mono">B_players = avg(mini) of <b>Playing</b></div>
    <div class="muted mono">B_final =
      <span id="formulaText">clip(w¬∑B_team + (1‚àíw)¬∑B_players, 0..1)</span>
    </div>
    <div class="muted mono" style="margin-top:6px">B_team: <span id="bTeamShow">0.50</span> ‚Ä¢ B_players: <span id="bPlayersShow">0.65</span> ‚Ä¢ B_raw: <span id="bRawShow">0.50</span></div>
  </div>

  <div class="card">
    <h2>One‚ÄëTap Rally</h2>
    <div class="row">
      <button class="btn good" id="win3">‚úÖ Win 3‚Äëball</button>
      <button class="btn good" id="win2">‚úÖ Win 2‚Äëball</button>
      <button class="btn bad"  id="loss3">‚ùå Loss 3‚Äëball</button>
      <button class="btn bad"  id="loss2">‚ùå Loss 2‚Äëball</button>
      <button class="btn small" id="errTeam">‚ö†Ô∏è Team error</button>
      <button class="btn small" id="errPlayers">üßØ Errors (players)</button>
      <button class="btn small" id="undo">‚Ü©Ô∏è Undo</button>
      <button class="btn small" id="reset">‚ôªÔ∏è Reset</button>
      <button class="btn small" id="exportCsv">‚¨áÔ∏è Export CSV</button>
    </div>
  </div>

  <div class="card">
    <h2>Single‚ÄëTap Variables</h2>
    <div class="row">
      <span class="chip" id="mChip">m: <strong id="mShow">0</strong></span>
      <span class="chip" id="wChip">w: <strong id="wShow">0.00</strong></span>
      <span class="chip" id="cChip">c: <strong id="cShow">1.00</strong></span>
      <span class="chip" id="rChip">r: <strong id="rShow">0.50</strong></span>
      <span class="chip" id="kChip">k: <strong id="kShow">0.00</strong></span>
    </div>
    <div class="muted">Tap to cycle: m (‚àí1/0/+1), w (‚àí1‚Ä¶+1), c (1/0.6/0.3), r (0.3/0.5/0.7), k (‚àí0.10‚Ä¶+0.10)</div>
  </div>

  <div class="card">
    <h2>Players (affect budget)</h2>
    <table id="playersTable">
      <thead><tr><th>#</th><th>Name</th><th>Status</th><th>Mini‚Äëbudget</th><th>Touch</th><th>Tag</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="subHint">üîÅ Sub Hint</button>
      <span class="muted mono" id="onCourtAvg"></span>
    </div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h2>What is <code>clip(x, a, b)</code>?</h2>
    <div class="muted">It ‚Äúclamps‚Äù a value to a range. Definition: <span class="mono">clip(x,a,b) = max(a, min(x, b))</span>.</div>
    <div class="muted" style="margin-top:6px">Live: <span class="mono">x=<span id="clipX">0.50</span> ‚Üí clip(x, 0, 1) = <span id="clipOut">0.50</span></span></div>
  </div>
</div>

<!-- Error Sharing Sheet -->
<div class="sheet" id="errSheet">
  <h2>Mark player errors (this rally)</h2>
  <div id="errPlayersList" class="row"></div>
  <div class="row" style="margin-top:10px">
    <button class="btn small" id="applyErr">Apply penalties</button>
    <button class="btn small" id="closeErr">Close</button>
  </div>
  <div class="muted" style="margin-top:6px">Penalty is shared: each selected player gets ‚àí0.03 to mini‚Äëbudget (clipped), and team cleanliness for this rally counts as an error.</div>
</div>

<div class="footer"><div class="muted">Tip: Save to Files ‚Üí open in Safari ‚Üí Share ‚Üí ‚ÄúAdd to Home Screen‚Äù for app‚Äëlike feel.</div></div>

<script>
let us=0, them=0;
let lastResults=[], lastErrors=[];
let vibe=0.5, k=0;
let mManual=null, wManual=null, cManual=null, rManual=null, kManual=null;
let history=[];
let eventLog=[]; // for CSV
let mode='blend'; // 'blend' or 'bottleneck'
let wTeam=0.70; // team weight for blend
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

const playersDefault=[
  {name:'Labeeb',  status:'Playing', mini:0.70},
  {name:'Jassim',  status:'Playing', mini:0.60},
  {name:'Areej',   status:'Playing', mini:0.70},
  {name:'Jawad',   status:'Playing', mini:0.60},
  {name:'Samad',   status:'Playing', mini:0.70},
  {name:'Shanoob', status:'Playing', mini:0.60},
  {name:'Shamal',  status:'Sub',     mini:0.75},
];
let players=JSON.parse(JSON.stringify(playersDefault));

function marginVal(){ if(mManual!==null) return mManual; const d=us-them; if(d>=2) return 1; if(d<=-2) return -1; return 0; }
function momentumVal(){ if(wManual!==null) return wManual; const w=lastResults.filter(x=>'win'===x).length; const l=lastResults.filter(x=>'loss'===x).length; return (w-l)/3; }
function cleanlinessVal(){ if(cManual!==null) return cManual; const s=lastErrors.reduce((a,b)=>a+b,0); if(s===0) return 1.0; if(s===1) return 0.6; return 0.3; }
function rVal(){ return (rManual!==null)?rManual:vibe; }
function kVal(){ return (kManual!==null)?kManual:k; }
function bTeamRaw(){ return 0.3*marginVal()+0.3*momentumVal()+0.3*cleanlinessVal()+0.1*rVal()+kVal(); }
function bTeam(){ return clamp(bTeamRaw(),0,1); }
function bPlayers(){
  const on=players.filter(p=>p.status==='Playing');
  if(on.length===0) return 0.5;
  const avg=on.reduce((s,p)=>s+(p.mini||0.6),0)/on.length;
  return clamp(avg,0,1);
}
function bRawCombined(team, playersAvg){
  if(!document.getElementById('usePlayers').checked) return team;
  if(mode==='bottleneck') return Math.min(team, playersAvg);
  return wTeam*team + (1-wTeam)*playersAvg;
}
function bFinal(){
  const team=bTeam(); const playersAvg=bPlayers();
  const raw=bRawCombined(team, playersAvg);
  return clamp(raw,0,1);
}

function flash(el){ el.classList.add('flash'); setTimeout(()=>el.classList.remove('flash'),140); }

function updateUI(){
  const team=bTeam(), playersAvg=bPlayers();
  const raw=bRawCombined(team, playersAvg);
  const finalB=clamp(raw,0,1);
  const m=marginVal(), w=momentumVal(), c=cleanlinessVal(), r=rVal(), kk=kVal();

  document.getElementById('bVal').textContent=finalB.toFixed(2);
  document.getElementById('bTeamShow').textContent=team.toFixed(2);
  document.getElementById('bPlayersShow').textContent=playersAvg.toFixed(2);
  document.getElementById('bRawShow').textContent=raw.toFixed(2);
  document.getElementById('mShow').textContent=(m>0?('+'+m):m);
  document.getElementById('wShow').textContent=(w>=0?('+'+w.toFixed(2)):w.toFixed(2));
  document.getElementById('cShow').textContent=c.toFixed(2);
  document.getElementById('rShow').textContent=r.toFixed(2);
  document.getElementById('kShow').textContent=(kk>=0?('+'+kk.toFixed(2)):kk.toFixed(2));

  const bar=document.getElementById('bar'); bar.style.width=(finalB*100)+'%';
  const callPill=document.getElementById('callPill'); const budgetPill=document.getElementById('budgetPill');
  if(finalB<0.35){ callPill.className='pill save'; callPill.textContent='Call: SAVE'; bar.style.background='#0a84ff'; budgetPill.className='pill save'; }
  else if(finalB<0.65){ callPill.className='pill std'; callPill.textContent='Call: STANDARD'; bar.style.background='#34c759'; budgetPill.className='pill std'; }
  else{ callPill.className='pill spend'; callPill.textContent='Call: SPEND'; bar.style.background='#ffd60a'; budgetPill.className='pill spend'; }
  flash(budgetPill);

  // Update labels
  document.getElementById('wTeamLabel').textContent=wTeam.toFixed(2);
  document.getElementById('wPlayersLabel').textContent=(1-wTeam).toFixed(2);
  document.getElementById('formulaText').textContent = (mode==='bottleneck')
    ? 'min(B_team, B_players)'
    : 'clip(w¬∑B_team + (1‚àíw)¬∑B_players, 0..1)';

  // on-court avg label
  const on=players.filter(p=>p.status==='Playing');
  const avg=on.length? (on.reduce((s,p)=>s+(p.mini||0.6),0)/on.length) : 0;
  document.getElementById('onCourtAvg').textContent = `On‚Äëcourt avg mini: ${avg.toFixed(2)} (${on.length} players)`;

  // clip demo
  document.getElementById('clipX').textContent=raw.toFixed(2);
  document.getElementById('clipOut').textContent=clamp(raw,0,1).toFixed(2);

  // score pill
  document.getElementById('us').textContent=us;
  document.getElementById('them').textContent=them;
}

function pushHistory(extra={}){
  history.push({
    us, them, lastResults:[...lastResults], lastErrors:[...lastErrors], vibe, k,
    mManual, wManual, cManual, rManual, kManual,
    players:JSON.parse(JSON.stringify(players)),
    usePlayers:document.getElementById('usePlayers').checked, mode, wTeam,
    ...extra
  });
}

function logEvent(type, extra={}){
  const team=bTeam(), playersAvg=bPlayers();
  const raw=bRawCombined(team, playersAvg);
  const finalB=clamp(raw,0,1);
  const timestamp=new Date().toISOString();
  const entry={timestamp,type,us,them,
    m:marginVal(), w:momentumVal(), c:cleanlinessVal(), r:rVal(), k:kVal(),
    B_team:team, B_players:playersAvg, B_raw:raw, B_final:finalB,
    mode, wTeam,
    ...extra
  };
  eventLog.push(entry);
}

function rally(res,balls){
  if(res==='win') us++; else them++;
  lastResults.push(res); if(lastResults.length>3) lastResults.shift();
  k = (balls==='2') ? ((res==='win')?+0.10:-0.10) : ((res==='win')?+0.05:-0.05);
  lastErrors.push(0); if(lastErrors.length>3) lastErrors.shift();
  pushHistory({event:`rally:${res}:${balls}`});
  logEvent('rally',{result:res,balls});
  updateUI();
}

function markTeamErr(){
  if(lastErrors.length>0){
    lastErrors[lastErrors.length-1]=1;
    pushHistory({event:'team_error'});
    logEvent('team_error',{});
    updateUI();
  }
}

// ----- Error sharing sheet -----
function openErrSheet(){
  const sheet=document.getElementById('errSheet');
  const list=document.getElementById('errPlayersList');
  list.innerHTML='';
  players.filter(p=>p.status==='Playing').forEach((p)=>{
    const chip=document.createElement('div');
    chip.className='player-chip';
    chip.dataset.name=p.name;
    chip.textContent=p.name;
    chip.addEventListener('click',()=>{ chip.classList.toggle('active'); });
    list.appendChild(chip);
  });
  sheet.classList.add('open');
}
function closeErrSheet(){ document.getElementById('errSheet').classList.remove('open'); }
function applyErrPenalties(){
  const selected=[...document.querySelectorAll('.player-chip.active')].map(el=>el.dataset.name);
  if(selected.length>0){
    players.forEach(p=>{ if(selected.includes(p.name)){ p.mini = clamp((p.mini||0.6)-0.03,0,1); } });
    renderPlayers();
    if(lastErrors.length>0){ lastErrors[lastErrors.length-1]=1; }
    pushHistory({event:'player_errors',selected:[...selected]});
    logEvent('player_errors',{players:selected.join('|')});
  }
  updateUI(); closeErrSheet();
}

function undo(){
  if(history.length>0){
    const h=history.pop();
    us=h.us; them=h.them; lastResults=[...h.lastResults]; lastErrors=[...h.lastErrors]; vibe=h.vibe; k=h.k;
    mManual=h.mManual; wManual=h.wManual; cManual=h.cManual; rManual=h.rManual; kManual=h.kManual;
    players=JSON.parse(JSON.stringify(h.players));
    document.getElementById('usePlayers').checked = h.usePlayers;
    mode=h.mode; wTeam=h.wTeam;
    document.getElementById('wTeam').value=wTeam;
    document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
    renderPlayers(); updateUI();
  }
}
function resetAll(){
  us=0; them=0; lastResults=[]; lastErrors=[]; vibe=0.5; k=0;
  mManual=wManual=cManual=rManual=kManual=null; history=[]; eventLog=[];
  players=JSON.parse(JSON.stringify(playersDefault));
  mode='blend'; wTeam=0.70;
  document.getElementById('usePlayers').checked = true;
  document.getElementById('wTeam').value=wTeam;
  document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
  renderPlayers(); updateUI();
}

const cycles={ m:[-1,0,1], w:[-1,-0.33,0,0.33,1], c:[1.0,0.6,0.3], r:[0.3,0.5,0.7], k:[-0.10,-0.05,0,0.05,0.10] };
let idx={m:1,w:2,c:0,r:1,k:2};
function cycle(key){
  idx[key]=(idx[key]+1)%cycles[key].length;
  const v=cycles[key][idx[key]];
  if(key==='m') mManual=v;
  if(key==='w') wManual=v;
  if(key==='c') cManual=v;
  if(key==='r') rManual=v;
  if(key==='k') kManual=v;
  pushHistory({event:`cycle:${key}`,value:v});
  logEvent('cycle',{key,value:v});
  updateUI();
}

function renderPlayers(){
  const tbody=document.querySelector('#playersTable tbody');
  tbody.innerHTML='';
  players.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td data-label="#">${i+1}</td>
      <td data-label="Name"><input type="text" value="${p.name}" data-idx="${i}" class="pname" /></td>
      <td data-label="Status"><button class="tag ${p.status==='Playing'?'play':'sub'}" data-idx="${i}" data-role="toggle">${p.status}</button></td>
      <td data-label="Mini"><input type="number" step="0.01" min="0" max="1" value="${p.mini.toFixed(2)}" data-idx="${i}" class="pmini" /></td>
      <td data-label="Touch">
        <button class="tag play" data-idx="${i}" data-delta="0.05">üëç Good</button>
        <button class="tag sub" data-idx="${i}" data-delta="-0.05">‚ö†Ô∏è Error</button>
      </td>
      <td data-label="Tag"><span class="tag ${p.status==='Playing'?'play':'sub'}">${p.status}</span></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.pname').forEach(el=>el.addEventListener('input',e=>{ players[e.target.dataset.idx].name=e.target.value; updateUI(); }));
  tbody.querySelectorAll('[data-role="toggle"]').forEach(el=>el.addEventListener('click',e=>{
    const i=e.target.dataset.idx; players[i].status = (players[i].status==='Playing')?'Sub':'Playing'; renderPlayers(); updateUI();
    pushHistory({event:'toggle_status',i,status:players[i].status}); logEvent('toggle_status',{name:players[i].name,status:players[i].status});
  }));
  tbody.querySelectorAll('.pmini').forEach(el=>el.addEventListener('input',e=>{
    const i=e.target.dataset.idx; const v=parseFloat(e.target.value); players[i].mini = isNaN(v)?players[i].mini:clamp(v,0,1); updateUI();
    pushHistory({event:'set_mini',i,value:players[i].mini}); logEvent('set_mini',{name:players[i].name,mini:players[i].mini});
  }));
  tbody.querySelectorAll('[data-delta]').forEach(el=>el.addEventListener('click',e=>{
    const i=e.target.dataset.idx; const d=parseFloat(e.target.dataset.delta); players[i].mini = clamp((players[i].mini||0)+d,0,1); renderPlayers(); updateUI();
    pushHistory({event:'nudge_mini',i,delta:d}); logEvent('nudge_mini',{name:players[i].name,delta:d,mini:players[i].mini});
  }));
}

function exportCSV(){
  const headers=['timestamp','type','us','them','m','w','c','r','k','B_team','B_players','B_raw','B_final','mode','wTeam'];
  const rows=[headers.join(',')];
  eventLog.forEach(e=>{
    const line=headers.map(h=> (e[h]!==undefined? e[h] : '')).join(',');
    rows.push(line);
  });
  const csv=rows.join('\\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='volleyball_budget_log.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// Bind events
window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('win3').addEventListener('click',()=>rally('win','3'));
  document.getElementById('win2').addEventListener('click',()=>rally('win','2'));
  document.getElementById('loss3').addEventListener('click',()=>rally('loss','3'));
  document.getElementById('loss2').addEventListener('click',()=>rally('loss','2'));
  document.getElementById('errTeam').addEventListener('click',markTeamErr);
  document.getElementById('errPlayers').addEventListener('click',openErrSheet);
  document.getElementById('applyErr').addEventListener('click',applyErrPenalties);
  document.getElementById('closeErr').addEventListener('click',()=>{closeErrSheet();});
  document.getElementById('undo').addEventListener('click',undo);
  document.getElementById('reset').addEventListener('click',resetAll);
  document.getElementById('exportCsv').addEventListener('click',exportCSV);
  document.getElementById('mChip').addEventListener('click',()=>cycle('m'));
  document.getElementById('wChip').addEventListener('click',()=>cycle('w'));
  document.getElementById('cChip').addEventListener('click',()=>cycle('c'));
  document.getElementById('rChip').addEventListener('click',()=>cycle('r'));
  document.getElementById('kChip').addEventListener('click',()=>cycle('k'));
  document.getElementById('subHint').addEventListener('click',()=>{
    const B=bFinal();
    const on = players.filter(p=>p.status==='Playing').map(p=>({name:p.name,val:p.mini}));
    const bench = players.filter(p=>p.status==='Sub').map(p=>({name:p.name,val:p.mini}));
    let msg='';
    if(on.length===0||bench.length===0){
      msg='Mark Playing/Sub to get a hint.';
    } else {
      on.sort((a,b)=>a.val-b.val);
      bench.sort((a,b)=>b.val-a.val);
      if (B < 0.35){
        msg=`B=${B.toFixed(2)} (low). Swap OUT: ${on[0].name} (${on[0].val.toFixed(2)}) ‚Üî IN: ${bench[0].name} (${bench[0].val.toFixed(2)}).`;
      } else if (B >= 0.65){
        msg=`B=${B.toFixed(2)} (high). Ride hot hand; sub only for fatigue/role. Lowest on‚Äëcourt: ${on[0].name} (${on[0].val.toFixed(2)}).`;
      } else {
        msg=`B=${B.toFixed(2)} (standard). Situational sub. Lowest on‚Äëcourt: ${on[0].name}; best bench: ${bench[0].name}.`;
      }
    }
    document.getElementById('hint').textContent=msg;
  });
  document.getElementById('usePlayers').addEventListener('change',()=>{ pushHistory({event:'toggle_usePlayers',value:document.getElementById('usePlayers').checked}); logEvent('toggle_usePlayers',{value:document.getElementById('usePlayers').checked}); updateUI(); });
  document.getElementById('wTeam').addEventListener('input',e=>{ wTeam=parseFloat(e.target.value)||0; pushHistory({event:'set_wTeam',value:wTeam}); logEvent('set_wTeam',{value:wTeam}); updateUI(); });
  document.querySelectorAll('#modeSeg button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); mode=btn.dataset.mode;
      pushHistory({event:'set_mode',mode}); logEvent('set_mode',{mode}); updateUI();
    });
  });
  renderPlayers(); updateUI();
});
</script>
</body>
</html>